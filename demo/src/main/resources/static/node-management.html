<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚ç‚¹ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input {
            width: auto;
        }
        .section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .section-title {
            margin-top: 0;
            color: #2c3e50;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            margin-bottom: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success:hover { background: #219a52; }
        .btn-warning:hover { background: #e67e22; }
        .btn-info:hover { background: #138496; }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .nav-links {
            margin-top: 20px;
        }
        .nav-links a {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 10px;
            padding: 8px 15px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        .nav-links a:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .nav-links a.corda-admin {
            background: #9b59b6;
        }
        .nav-links a.corda-admin:hover {
            background: #8e44ad;
        }
        .nodes-list {
            margin-top: 20px;
        }
        .nodes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .nodes-table th, .nodes-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .nodes-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .nodes-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .nodes-table tr:hover {
            background-color: #f1f1f1;
        }
        .refresh-btn {
            margin-bottom: 10px;
        }
        .empty-message {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        .deploy-section {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .start-section {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        .deploy-warning {
            color: #856404;
            font-size: 14px;
            margin-top: 10px;
        }
        .start-info {
            color: #0c5460;
            font-size: 14px;
            margin-top: 10px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .action-buttons button {
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>èŠ‚ç‚¹ç®¡ç†</h1>
        
        <!-- èŠ‚ç‚¹åˆ—è¡¨ -->
        <div class="section">
            <h2 class="section-title">èŠ‚ç‚¹åˆ—è¡¨</h2>
            <button class="btn-success refresh-btn" onclick="loadNodesList()">åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨</button>
            <div id="nodesList" class="nodes-list">
                <div class="empty-message">æ­£åœ¨åŠ è½½èŠ‚ç‚¹åˆ—è¡¨...</div>
            </div>
        </div>

        <!-- æ„é€ ç½‘ç»œéƒ¨ç½² -->
        <div class="section deploy-section">
            <h2 class="section-title">æ„é€ èŠ‚ç‚¹ç½‘ç»œ</h2>
            <p class="deploy-warning">
                <strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œå°†æ‰§è¡Œ gradlew.bat clean deployNodes å‘½ä»¤ï¼Œé‡æ–°æ„å»ºå¹¶éƒ¨ç½²æ‰€æœ‰èŠ‚ç‚¹ã€‚
                è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
            </p>
            <button class="btn-warning" onclick="deployNetwork()" id="deployBtn">æ„é€ ç½‘ç»œ</button>
            <div id="deployStatus"></div>
        </div>

        <!-- å¯åŠ¨èŠ‚ç‚¹ -->
        <div class="section start-section">
            <h2 class="section-title">å¯åŠ¨èŠ‚ç‚¹</h2>
            <p class="start-info">
                <strong>è¯´æ˜ï¼š</strong>æ„é€ ç½‘ç»œå®Œæˆåï¼Œå¯ä»¥å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æˆ–å•ç‹¬å¯åŠ¨æŸä¸ªèŠ‚ç‚¹ã€‚
            </p>
            
            <div style="margin-bottom: 15px;">
                <button class="btn-info" onclick="startAllNodes()" id="startAllBtn">å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ (runnodes.bat)</button>
                <div id="startAllStatus" style="margin-top: 10px;"></div>
            </div>
            
            <div class="form-group">
                <label for="startNodeName">å¯åŠ¨å•ä¸ªèŠ‚ç‚¹:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="startNodeName" placeholder="è¾“å…¥èŠ‚ç‚¹åç§° (ä¾‹å¦‚: PartyA)" style="flex: 1;">
                    <button class="btn-info" onclick="startSingleNode()" id="startSingleBtn">å¯åŠ¨èŠ‚ç‚¹</button>
                </div>
                <div id="startSingleStatus" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- æ·»åŠ èŠ‚ç‚¹è¡¨å• -->
        <div class="section">
            <h2 class="section-title">æ·»åŠ èŠ‚ç‚¹</h2>
            <div class="form-group">
                <label for="nodeName">èŠ‚ç‚¹åç§°:</label>
                <input type="text" id="nodeName" placeholder="ä¾‹å¦‚: O=PartyE,L=Tokyo,C=JP">
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="autoPorts" onchange="togglePortFields()">
                    <label for="autoPorts">è‡ªåŠ¨åˆ†é…ç«¯å£</label>
                </div>
            </div>
            
            <div id="portFields">
                <div class="form-group">
                    <label for="p2pPort">P2P ç«¯å£:</label>
                    <input type="number" id="p2pPort" placeholder="ä¾‹å¦‚: 10012">
                </div>
                <div class="form-group">
                    <label for="rpcPort">RPC ç«¯å£:</label>
                    <input type="number" id="rpcPort" placeholder="ä¾‹å¦‚: 10013">
                </div>
                <div class="form-group">
                    <label for="adminPort">Admin ç«¯å£:</label>
                    <input type="number" id="adminPort" placeholder="ä¾‹å¦‚: 10053">
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="autoDb" onchange="toggleDbFields()">
                    <label for="autoDb">è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“é…ç½®</label>
                </div>
            </div>
            
            <div id="dbFields">
                <div class="form-group">
                    <label for="dbName">æ•°æ®åº“åç§°:</label>
                    <input type="text" id="dbName" placeholder="ä¾‹å¦‚: corda_party_e">
                </div>
                <div class="form-group">
                    <label for="dbUser">æ•°æ®åº“ç”¨æˆ·:</label>
                    <input type="text" id="dbUser" placeholder="ä¾‹å¦‚: user_e">
                </div>
            </div>
            
            <button class="btn-primary" onclick="addNode()">æ·»åŠ èŠ‚ç‚¹</button>
        </div>
        
        <!-- åˆ é™¤èŠ‚ç‚¹è¡¨å• -->
        <div class="section">
            <h2 class="section-title">åˆ é™¤èŠ‚ç‚¹</h2>
            <div class="form-group">
                <label for="removeNodeName">èŠ‚ç‚¹åç§°:</label>
                <input type="text" id="removeNodeName" placeholder="è¾“å…¥è¦åˆ é™¤çš„èŠ‚ç‚¹åç§°">
            </div>
            <button class="btn-danger" onclick="removeNode()">åˆ é™¤èŠ‚ç‚¹</button>
        </div>
        
        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="result"></div>
        
        <!-- å¯¼èˆªé“¾æ¥ -->
        <div class="nav-links">
            <a href="/test.html">è¿”å›ç™»å½•é¡µ</a>
            <a href="/dashboard.html">ä»ªè¡¨æ¿</a>
            <a href="/multi-node-dashboard.html" class="corda-admin">ğŸŒ Cordaç®¡ç†ç•Œé¢</a>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½èŠ‚ç‚¹åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = '/test.html';
                return;
            }
            
            // åŠ è½½èŠ‚ç‚¹åˆ—è¡¨
            loadNodesList();
        });
        
        // åŠ è½½èŠ‚ç‚¹åˆ—è¡¨å‡½æ•°
        function loadNodesList() {
            const nodesListDiv = document.getElementById('nodesList');
            nodesListDiv.innerHTML = '<div class="empty-message">æ­£åœ¨åŠ è½½èŠ‚ç‚¹åˆ—è¡¨...</div>';
            
            fetch('/api/nodes/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayNodesList(data.nodes, data.count);
                    } else {
                        nodesListDiv.innerHTML = `<div class="empty-message">åŠ è½½å¤±è´¥: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    nodesListDiv.innerHTML = `<div class="empty-message">è¯·æ±‚å¤±è´¥: ${error}</div>`;
                });
        }
        
        // æ˜¾ç¤ºèŠ‚ç‚¹åˆ—è¡¨ï¼ˆç§»é™¤çŠ¶æ€åˆ—ï¼‰
        function displayNodesList(nodes, count) {
            const nodesListDiv = document.getElementById('nodesList');
            
            if (!nodes || nodes.length === 0) {
                nodesListDiv.innerHTML = '<div class="empty-message">æš‚æ— èŠ‚ç‚¹</div>';
                return;
            }
            
            let html = `<p><strong>èŠ‚ç‚¹æ€»æ•°: ${count}</strong></p>`;
            html += '<table class="nodes-table">';
            html += '<thead><tr><th>åºå·</th><th>èŠ‚ç‚¹åç§°</th><th>ç›®å½•å</th><th>æ“ä½œ</th></tr></thead>';
            html += '<tbody>';
            
            nodes.forEach((node, index) => {
                let nodeDir = extractNodeDir(node);
                const badge = getNodeBadge(node);
                
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${node} ${badge}</td>
                    <td>${nodeDir}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-secondary" onclick="setRemoveNodeName('${node}')">åˆ é™¤</button>
                            <button class="btn-info" onclick="setStartNodeName('${nodeDir}')">å¯åŠ¨</button>
                            <button class="btn-danger" onclick="stopNodeByName('${nodeDir}', this)">ç»ˆæ­¢</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            nodesListDiv.innerHTML = html;
        }

        function getNodeBadge(nodeName) {
            const badges = {
                'PartyA': '<span style="background:#3498db;color:white;padding:2px 5px;border-radius:3px;font-size:12px;">A</span>',
                'PartyB': '<span style="background:#2ecc71;color:white;padding:2px 5px;border-radius:3px;font-size:12px;">B</span>',
                'PartyC': '<span style="background:#9b59b6;color:white;padding:2px 5px;border-radius:3px;font-size:12px;">C</span>',
                'PartyE': '<span style="background:#e74c3c;color:white;padding:2px 5px;border-radius:3px;font-size:12px;">E</span>'
            };
            
            const match = nodeName.match(/O=([^,]+)/);
            const orgName = match ? match[1] : nodeName;
            return badges[orgName] || '';
        }
        
        // ä»èŠ‚ç‚¹åç§°ä¸­æå–ç›®å½•å
        function extractNodeDir(nodeName) {
            // ä» "O=PartyA,L=London,C=GB" æå– "PartyA"
            const match = nodeName.match(/O=([^,]+)/);
            return match ? match[1] : nodeName;
        }
        
        // è®¾ç½®åˆ é™¤èŠ‚ç‚¹åç§°
        function setRemoveNodeName(nodeName) {
            document.getElementById('removeNodeName').value = nodeName;
            // æ»šåŠ¨åˆ°åˆ é™¤èŠ‚ç‚¹è¡¨å•
            document.getElementById('removeNodeName').scrollIntoView({ behavior: 'smooth' });
        }
        
        // è®¾ç½®å¯åŠ¨èŠ‚ç‚¹åç§°
        function setStartNodeName(nodeDir) {
            document.getElementById('startNodeName').value = nodeDir;
            // æ»šåŠ¨åˆ°å¯åŠ¨èŠ‚ç‚¹è¡¨å•
            document.getElementById('startNodeName').scrollIntoView({ behavior: 'smooth' });
        }
        
        // æ„é€ ç½‘ç»œå‡½æ•°
        function deployNetwork() {
            const deployBtn = document.getElementById('deployBtn');
            const deployStatus = document.getElementById('deployStatus');
            
            if (!confirm('ç¡®å®šè¦æ„é€ ç½‘ç»œå—ï¼Ÿè¿™å°†æ‰§è¡Œ gradlew.bat clean deployNodes å‘½ä»¤ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            deployBtn.disabled = true;
            deployBtn.innerHTML = '<span class="loading"></span>æ„é€ ç½‘ç»œä¸­...';
            deployStatus.innerHTML = '<div class="result info">æ­£åœ¨æ„é€ ç½‘ç»œï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';
            deployStatus.style.display = 'block';
            
            fetch('/api/nodes/deploy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    deployStatus.innerHTML = `<div class="result success">
                        <strong>æˆåŠŸ:</strong> ç½‘ç»œæ„é€ å®Œæˆï¼<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹è¾“å‡ºè¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.output}</pre>
                        </details>
                    </div>`;
                } else {
                    deployStatus.innerHTML = `<div class="result error">
                        <strong>é”™è¯¯:</strong> ${data.message}<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.error || data.output}</pre>
                        </details>
                    </div>`;
                }
            })
            .catch(error => {
                deployStatus.innerHTML = `<div class="result error">
                    <strong>è¯·æ±‚å¤±è´¥:</strong> ${error}
                </div>`;
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                deployBtn.disabled = false;
                deployBtn.innerHTML = 'æ„é€ ç½‘ç»œ';
            });
        }
        
        // å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
        function startAllNodes() {
            const startAllBtn = document.getElementById('startAllBtn');
            const startAllStatus = document.getElementById('startAllStatus');
            
            if (!confirm('ç¡®å®šè¦å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿè¿™å°†è¿è¡Œ build/nodes/runnodes.bat è„šæœ¬ã€‚')) {
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            startAllBtn.disabled = true;
            startAllBtn.innerHTML = '<span class="loading"></span>å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ä¸­...';
            startAllStatus.innerHTML = '<div class="result info">æ­£åœ¨å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';
            startAllStatus.style.display = 'block';
            
            fetch('/api/nodes/start-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    startAllStatus.innerHTML = `<div class="result success">
                        <strong>æˆåŠŸ:</strong> æ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹è¾“å‡ºè¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.output}</pre>
                        </details>
                    </div>`;
                } else {
                    startAllStatus.innerHTML = `<div class="result error">
                        <strong>é”™è¯¯:</strong> ${data.message}<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.error || data.output}</pre>
                        </details>
                    </div>`;
                }
            })
            .catch(error => {
                startAllStatus.innerHTML = `<div class="result error">
                    <strong>è¯·æ±‚å¤±è´¥:</strong> ${error}
                </div>`;
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                startAllBtn.disabled = false;
                startAllBtn.innerHTML = 'å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ (runnodes.bat)';
            });
        }
        
        // å¯åŠ¨å•ä¸ªèŠ‚ç‚¹
        function startSingleNode() {
            const nodeName = document.getElementById('startNodeName').value;
            const startSingleBtn = document.getElementById('startSingleBtn');
            const startSingleStatus = document.getElementById('startSingleStatus');
            
            if (!nodeName) {
                showResult('é”™è¯¯: è¯·è¾“å…¥è¦å¯åŠ¨çš„èŠ‚ç‚¹åç§°', false);
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦å¯åŠ¨èŠ‚ç‚¹ "${nodeName}" å—ï¼Ÿ`)) {
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            startSingleBtn.disabled = true;
            startSingleBtn.innerHTML = '<span class="loading"></span>å¯åŠ¨ä¸­...';
            startSingleStatus.innerHTML = '<div class="result info">æ­£åœ¨å¯åŠ¨èŠ‚ç‚¹ï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';
            startSingleStatus.style.display = 'block';
            
            fetch('/api/nodes/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nodeName: nodeName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    startSingleStatus.innerHTML = `<div class="result success">
                        <strong>æˆåŠŸ:</strong> èŠ‚ç‚¹ ${nodeName} å¯åŠ¨æˆåŠŸï¼<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹è¾“å‡ºè¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.output}</pre>
                        </details>
                    </div>`;
                } else {
                    startSingleStatus.innerHTML = `<div class="result error">
                        <strong>é”™è¯¯:</strong> ${data.message}<br>
                        <details style="margin-top: 10px;">
                            <summary>æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</summary>
                            <pre style="background: white; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px;">${data.error || data.output}</pre>
                        </details>
                    </div>`;
                }
            })
            .catch(error => {
                startSingleStatus.innerHTML = `<div class="result error">
                    <strong>è¯·æ±‚å¤±è´¥:</strong> ${error}
                </div>`;
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                startSingleBtn.disabled = false;
                startSingleBtn.innerHTML = 'å¯åŠ¨èŠ‚ç‚¹';
            });
        }
        function stopNodeByName(nodeDir, btn) {
            if (!nodeDir) {
                showResult('é”™è¯¯: æ— æ•ˆçš„èŠ‚ç‚¹ç›®å½•å', false);
                return;
            }
            if (!confirm(`ç¡®å®šè¦ç»ˆæ­¢èŠ‚ç‚¹ "${nodeDir}" å—ï¼Ÿ`)) return;

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç»ˆæ­¢ä¸­...';

            fetch('/api/nodes/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nodeName: nodeDir })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult(`èŠ‚ç‚¹ ${nodeDir} å·²ç»ˆæ­¢ï¼ˆå¦‚ç»ˆæ­¢å¤±è´¥è¯·æŸ¥çœ‹è¾“å‡ºï¼‰`, true);
                    // åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                    loadNodesList();
                } else {
                    showResult('èŠ‚ç‚¹ç»ˆæ­¢å¤±è´¥: ' + (data.message || data.error || data.output), false);
                }
            })
            .catch(error => {
                showResult('è¯·æ±‚å¤±è´¥: ' + error, false);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        }

        
        function togglePortFields() {
            const autoPorts = document.getElementById('autoPorts').checked;
            document.getElementById('portFields').style.display = autoPorts ? 'none' : 'block';
        }
        
        function toggleDbFields() {
            const autoDb = document.getElementById('autoDb').checked;
            document.getElementById('dbFields').style.display = autoDb ? 'none' : 'block';
        }
        
        function addNode() {
            const request = {
                nodeName: document.getElementById('nodeName').value,
                autoPorts: document.getElementById('autoPorts').checked,
                autoDb: document.getElementById('autoDb').checked
            };
            
            if (!request.nodeName) {
                showResult('é”™è¯¯: è¯·è¾“å…¥èŠ‚ç‚¹åç§°', false);
                return;
            }
            
            if (!request.autoPorts) {
                request.p2pPort = parseInt(document.getElementById('p2pPort').value);
                request.rpcPort = parseInt(document.getElementById('rpcPort').value);
                request.adminPort = parseInt(document.getElementById('adminPort').value);
            }
            
            if (!request.autoDb) {
                request.dbName = document.getElementById('dbName').value;
                request.dbUser = document.getElementById('dbUser').value;
            }
            
            fetch('/api/nodes/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('èŠ‚ç‚¹æ·»åŠ æˆåŠŸï¼è¾“å‡º: ' + data.output, true);
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('nodeName').value = '';
                    document.getElementById('p2pPort').value = '';
                    document.getElementById('rpcPort').value = '';
                    document.getElementById('adminPort').value = '';
                    document.getElementById('dbName').value = '';
                    document.getElementById('dbUser').value = '';
                    // åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨
                    loadNodesList();
                } else {
                    showResult('èŠ‚ç‚¹æ·»åŠ å¤±è´¥: ' + data.message + (data.error ? ' - ' + data.error : ''), false);
                }
            })
            .catch(error => showResult('è¯·æ±‚å¤±è´¥: ' + error, false));
        }
        
        function removeNode() {
            const nodeName = document.getElementById('removeNodeName').value;
            
            if (!nodeName) {
                showResult('é”™è¯¯: è¯·è¾“å…¥è¦åˆ é™¤çš„èŠ‚ç‚¹åç§°', false);
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${nodeName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                return;
            }
            
            fetch('/api/nodes/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nodeName: nodeName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('èŠ‚ç‚¹åˆ é™¤æˆåŠŸï¼è¾“å‡º: ' + data.output, true);
                    document.getElementById('removeNodeName').value = '';
                    // åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨
                    loadNodesList();
                } else {
                    showResult('èŠ‚ç‚¹åˆ é™¤å¤±è´¥: ' + data.message + (data.error ? ' - ' + data.error : ''), false);
                }
            })
            .catch(error => showResult('è¯·æ±‚å¤±è´¥: ' + error, false));
        }
        
        function showResult(message, isSuccess) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultDiv.innerHTML = `<strong>${isSuccess ? 'æˆåŠŸ' : 'é”™è¯¯'}:</strong> ${message}`;
            
            // 5ç§’åè‡ªåŠ¨éšè—ç»“æœ
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }
        
        // åˆå§‹åŒ–æ˜¾ç¤º/éšè—å­—æ®µ
        togglePortFields();
        toggleDbFields();
    </script>
</body>
</html>